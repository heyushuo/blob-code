<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>第2章Object的变化检测</title>
  </head>

  <body></body>
</html>
<script>
  //2.2 如何追踪变化
  function defineReactive(data, key, val) {
    Object.defineProperty(data, key, {
      enumerable: true, //可枚举
      configurable: true, //可配置
      get: function() {
        return val;
      },
      set: function(newVal) {
        if (val === newVal) {
          return val;
        }
        val = newVal;
      }
    });
  }
  //2.3 如何依赖收集
  // 在getter中收集依赖,在setter中出发依赖
  //2.4 依赖收集在哪里
  //创建一个Dep数组,用来储存被收集的依赖
  class Dep {
    constructor() {
      this.subs = [];
    }
    addSub(sub) {
      this.subs.push(sub);
    }
    removeSub(sub) {
      remove(this.subs, sub);
    }
    depend() {
      if (window.target) {
        this.addSub(window.target);
      }
    }
    notify() {
      const subs = this.subs.slice(); //对数组进行复制
      for (let i = 0; i < subs.length; i++) {
        subs[i].update();
      }
    }
  }
  function remove(arr, item) {
    if (arr.length) {
      const index = arr.indexOf(item);
      return arr.splice(index, 1);
    }
  }

  //改造defineReactive如下
  function defineReactive(data, key, val) {
    let dep = new Dep();
    Object.defineProperty(data, key, {
      enumerable: true, //可枚举
      configurable: true, //可配置
      get: function() {
        dep.depend(); //添加到数组
        return val;
      },
      set: function(newVal) {
        if (val === newVal) {
          return val;
        }
        val = newVal;
        dep.notify();
      }
    });
  }
</script>
